导航
=========

.. _SLAM: SLAM.html
.. _板载计算机IP: 快速上手指引.html#ip

室内导航
------------

.. note::
    在进行导航功能之前，确保您已经完成 SLAM_ 相关工作，有一张地图。


1. 将小车上电，等待板载计算机、飞控、移动端RTK、移动端Homer启动完成
2. 打开遥控器
3. 在PC上打开 No Machine 软件，输入 **192.168.1.14** 远程连接到板载计算机。
   
   .. note::
       板载计算机的固定IP，取决您如何设置 板载计算机IP_

4. 输入密码 **amov** 登录到板载计算机
5. 打开板载计算机桌面的 **sh** 文件夹后，右键选择 **open terminal**
6. 输入命令 ``bash r300_navigation_indoor.sh`` 启动室内导航建图脚本。
7. 在启动的 **rviz** 界面顶部的菜单栏中，选择 **2D Pose Estimate**，将机器人放置在地图中的实际位置，然后用遥控器控制E300前后左右稍微移动，待R300周围的粒子聚集即可。
8. 在启动的 **rviz** 界面顶部的菜单栏中，选择 **Navigation Goal**，单击地图以设置机器人的目的地，然后将绿色箭头指向机器人在目标点将要面对的方向。
9. 将遥控器上的档杆SWB拨至顶部，R300将会开始导航


室外Navigation避障
-------------------

.. note:: 
    在进行室外Navigation避障之前，请将小车移动到开阔地带，便于卫星定位，以达到较好的效果

1. 将小车上电，等待板载计算机、飞控、移动端RTK、移动端Homer启动完成
2. 打开遥控器
3. 在PC上打开 No Machine 软件，输入 **192.168.1.14** 远程连接到板载计算机。
   
   .. note::
       板载计算机的固定IP，取决您如何设置 板载计算机IP_

4. 输入密码 **amov** 登录到板载计算机
5. 在PC上打开 Mission Planner 软件，在右上角选择连接方式为 **TCP**，波特率为 **57600**
6. 在弹出的对话框输入飞控IP地址 **192.168.1.11**，端口号为 **8080**
7. 飞控连接上以后，等待GPS进入 rtk fixed状态，并且EKF没有报红。如下图所示:
   
   .. image:: ../pics/rtk_fixed.png
       :alt: rtk_fixed
8. 打开板载计算机桌面的 **sh** 文件夹后，右键选择 **open terminal**
9. 输入命令 ``bash r300_navigation_outdoor.sh`` 启动室外navigation避障脚本。
10.  在启动的 **rviz** 界面顶部的菜单栏中，选择 **Navigation Goal**，单击地图以设置机器人的目的地，然后将绿色箭头指向机器人在目标点将要面对的方向。
11. 将遥控器上的档杆SWB拨至顶部，R300将会开始导航


.. note::
    `功能演示视频 <https://www.bilibili.com/video/BV1DS4y1R7T8?spm_id_from=333.999.0.0>`_


室外航点规划及避障
----------------------

1. 将小车上电，等待板载计算机、飞控、移动端RTK、移动端Homer启动完成
2. 打开遥控器
3. 在PC上打开 No Machine 软件，输入 **192.168.1.14** 远程连接到板载计算机。
   
   .. note::
       板载计算机的固定IP，取决您如何设置 板载计算机IP_

4. 输入密码 **amov** 登录到板载计算机
5. 在PC上打开 Mission Planner 软件，在右上角选择连接方式为 **TCP**，波特率为 **57600**
6. 在弹出的对话框输入飞控IP地址 **192.168.1.11**，端口号为 **8080**
7. 飞控连接上以后，等待GPS进入 rtk fixed状态，并且EKF没有报红。如下图所示:
   
   .. image:: ../pics/rtk_fixed.png
       :alt: rtk_fixed

8. 点击Mission Planner工具栏上的 飞行计划，在地图界面规划航点，然后点击右边的写入航点按钮
9.  打开板载计算机的终端
10. 输入命令 ``roscd r300_function/sh && bash r300_navigation_wp_goal.sh`` 启动室外航点规划及避障功能。
11. 打开一个新的终端，输入命令 ``rosservice call /mavros/mission/pull``
12. 打开第10步启动的终端界面，在最后一个标签页中， **先输入1获取航点信息，等获取到航点信息后，再次输入1启动**，如下图所示
    
    .. image:: ../pics/wp.png
       :alt: wp

13. 将遥控器上的档杆SWB拨至顶部，让R300受板载计算机的控制，开始执行航点规划


.. note::
    -  使用室外航点规划及避障，需要更新最新版本的代码。代码地址见 `gitee <https://gitee.com/amovlab/amovcar/tree/v1.0-beta/>`_，选择分支为 **v1.0-beta**